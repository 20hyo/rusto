name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manual trigger

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Check code
        run: cargo check

      - name: Run tests
        run: cargo test

      - name: Build release
        run: cargo build --release

  deploy:
    name: Deploy to Tokyo EC2 (t4g.small ARM)
    runs-on: ubuntu-latest
    needs: test  # Only deploy if tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Upload config.toml from repo to EC2 (ensures latest config is applied)
          scp -o StrictHostKeyChecking=no config.toml ${EC2_USER}@${EC2_HOST}:/tmp/rusto.config.toml
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            printf 'DISCORD_WEBHOOK_URL=%s\n' "$DISCORD_WEBHOOK_URL" > /tmp/rusto.env
            scp -o StrictHostKeyChecking=no /tmp/rusto.env ${EC2_USER}@${EC2_HOST}:/tmp/rusto.env
            rm -f /tmp/rusto.env
          fi

          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            set -e

            echo "=== Starting Rusto deployment ==="
            APP_DIR="/home/ec2-user/rusto"
            APP_USER="ec2-user"

            # Check if Rust is installed
            if [ ! -f "$HOME/.cargo/env" ]; then
              echo "Installing Rust..."
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            fi
            source "$HOME/.cargo/env"

            # Navigate to application directory or clone if not exists
            if [ -d "$APP_DIR/.git" ]; then
              echo "Found existing application directory"
              cd "$APP_DIR"
            elif [ -d "$APP_DIR" ]; then
              echo "Repository directory exists but is not a git repo: $APP_DIR"
              exit 1
            else
              echo "Repository not found, cloning..."
              git clone https://github.com/20hyo/rusto.git "$APP_DIR"
              cd "$APP_DIR"
            fi

            # Pull latest changes
            echo "Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # Overwrite config.toml with the uploaded version from CI (if present)
            if [ -f /tmp/rusto.config.toml ]; then
              cp /tmp/rusto.config.toml "$APP_DIR/config.toml"
              chown "$APP_USER:$APP_USER" "$APP_DIR/config.toml"
            fi

            if [ -f /tmp/rusto.env ]; then
              # shellcheck disable=SC1091
              . /tmp/rusto.env
            fi

            # Update .env if not exists
            if [ ! -f "$APP_DIR/.env" ]; then
              cp "$APP_DIR/.env.example" "$APP_DIR/.env" 2>/dev/null || echo "DISCORD_WEBHOOK_URL=" > "$APP_DIR/.env"
              chown "$APP_USER:$APP_USER" "$APP_DIR/.env"
            fi

            # Update DISCORD_WEBHOOK_URL
            if [ -n "$DISCORD_WEBHOOK_URL" ]; then
              if grep -q "^DISCORD_WEBHOOK_URL=" "$APP_DIR/.env"; then
                sed -i "s|^DISCORD_WEBHOOK_URL=.*|DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}|" "$APP_DIR/.env"
              else
                echo "DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}" >> "$APP_DIR/.env"
              fi
            fi

            # Load Rust environment
            source "$HOME/.cargo/env"

            # Check and create swap if needed (for low-memory instances)
            if [ ! -f /swapfile ]; then
              echo "Creating swap file for build (requires sudo)..."
              sudo dd if=/dev/zero of=/swapfile bs=1M count=2048 status=progress
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              echo "Swap created successfully"
            else
              echo "Swap already exists"
              sudo swapon /swapfile || true
            fi

            if [ ! -f /home/$APP_USER/.cargo/env ]; then
              sudo -u "$APP_USER" bash -lc "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"
            fi

            # Show config for debugging
            echo "=== config.toml [general] section ==="
            grep -A 10 '^\[general\]' "$APP_DIR/config.toml" || echo "(not found)"

            # Build release binary with limited parallelism to avoid OOM
            echo "Building release binary..."
            sudo -u "$APP_USER" bash -lc "source /home/$APP_USER/.cargo/env && cd $APP_DIR && cargo build --release -j 1"

            # Verify binary was just built (mtime within last 60s)
            echo "Binary mtime: $(stat -c '%y' \"$APP_DIR/target/release/rusto\" 2>/dev/null || stat -f '%Sm' \"$APP_DIR/target/release/rusto\")"

            echo "Replacing rusto.service for /home/ec2-user/rusto deployment"
            sudo tee /etc/systemd/system/rusto.service > /dev/null <<'RUSTO_SERVICE'
[Unit]
Description=Rusto Trading Bot
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=/home/ec2-user/rusto
Environment="PATH=/home/ec2-user/.cargo/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=/home/ec2-user/rusto/target/release/rusto
Restart=always
RestartSec=10
StandardOutput=append:/home/ec2-user/rusto/rusto.log
StandardError=append:/home/ec2-user/rusto/rusto.error.log

[Install]
WantedBy=multi-user.target
RUSTO_SERVICE

            sudo systemctl daemon-reload

            # Restart service
            echo "Restarting rusto service..."
            sudo systemctl restart rusto

            # Check status
            sleep 3
            sudo systemctl status rusto --no-pager

            echo "=== Deployment completed successfully ==="
          ENDSSH

      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            # Wait for service to be fully started
            sleep 5

            # Check if service is running
            if sudo systemctl is-active --quiet rusto; then
              echo "✓ Service is running"

              # Show recent logs
              echo ""
              echo "Recent logs:"
              sudo journalctl -u rusto -n 20 --no-pager

              exit 0
            else
              echo "✗ Service failed to start"
              echo ""
              echo "Error logs:"
              sudo journalctl -u rusto -n 50 --no-pager

              exit 1
            fi
          ENDSSH

      - name: Send deployment notification
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            COLOR=3066993
            TITLE="✅ Deployment Successful"
            DESCRIPTION="Rusto bot has been deployed to Tokyo EC2"
          else
            COLOR=15158332
            TITLE="❌ Deployment Failed"
            DESCRIPTION="Rusto bot deployment failed. Check logs."
          fi

          curl -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"$TITLE\", \"description\": \"$DESCRIPTION\", \"color\": $COLOR, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            "$DISCORD_WEBHOOK_URL" || true
