name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manual trigger

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Check code
        run: cargo check

      - name: Run tests
        run: cargo test

  deploy:
    name: Deploy to Tokyo EC2 (t4g.small ARM)
    runs-on: ubuntu-latest
    needs: test  # Only deploy if tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          cargo build --release

          # Upload config.toml from repo to EC2 (ensures latest config is applied)
          scp -o StrictHostKeyChecking=no config.toml ${EC2_USER}@${EC2_HOST}:/tmp/rusto.config.toml
          scp -o StrictHostKeyChecking=no target/release/rusto ${EC2_USER}@${EC2_HOST}:/tmp/rusto-release
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            printf 'DISCORD_WEBHOOK_URL=%s\n' "$DISCORD_WEBHOOK_URL" > /tmp/rusto.env
            scp -o StrictHostKeyChecking=no /tmp/rusto.env ${EC2_USER}@${EC2_HOST}:/tmp/rusto.env
            rm -f /tmp/rusto.env
          fi

          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            set -e

            echo "=== Starting Rusto deployment ==="
            APP_DIR="/home/ec2-user/rusto"
            APP_USER="ec2-user"

            mkdir -p "$APP_DIR"
            mkdir -p "$APP_DIR/target/release"

            # Overwrite config.toml with the uploaded version from CI (if present)
            if [ -f /tmp/rusto.config.toml ]; then
              cp /tmp/rusto.config.toml "$APP_DIR/config.toml"
              chown "$APP_USER:$APP_USER" "$APP_DIR/config.toml"
            fi

            if [ -f /tmp/rusto.env ]; then
              # shellcheck disable=SC1091
              . /tmp/rusto.env
            fi

            # Update .env if not exists
            if [ ! -f "$APP_DIR/.env" ]; then
              cp "$APP_DIR/.env.example" "$APP_DIR/.env" 2>/dev/null || echo "DISCORD_WEBHOOK_URL=" > "$APP_DIR/.env"
              chown "$APP_USER:$APP_USER" "$APP_DIR/.env"
            fi

            # Update DISCORD_WEBHOOK_URL
            if [ -n "$DISCORD_WEBHOOK_URL" ]; then
              if grep -q "^DISCORD_WEBHOOK_URL=" "$APP_DIR/.env"; then
                sed -i "s|^DISCORD_WEBHOOK_URL=.*|DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}|" "$APP_DIR/.env"
              else
                echo "DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}" >> "$APP_DIR/.env"
              fi
            fi

            # Deploy release binary
            if [ -f /tmp/rusto-release ]; then
              mv /tmp/rusto-release "$APP_DIR/target/release/rusto"
              chown "$APP_USER:$APP_USER" "$APP_DIR/target/release/rusto"
              chmod +x "$APP_DIR/target/release/rusto"
            else
              echo "Release binary not found: /tmp/rusto-release"
              exit 1
            fi

            # Show config for debugging
            echo "=== config.toml [general] section ==="
            grep -A 10 '^\[general\]' "$APP_DIR/config.toml" || echo "(not found)"

            echo "Replacing rusto.service for /home/ec2-user/rusto deployment"
            printf '%s\n' \
              "[Unit]" \
              "Description=Rusto Trading Bot" \
              "After=network.target" \
              "" \
              "[Service]" \
              "Type=simple" \
              "User=ec2-user" \
              "WorkingDirectory=/home/ec2-user/rusto" \
              "Environment=\"PATH=/home/ec2-user/.cargo/bin:/usr/local/bin:/usr/bin:/bin\"" \
              "ExecStart=/home/ec2-user/rusto/target/release/rusto" \
              "Restart=always" \
              "RestartSec=10" \
              "StandardOutput=append:/home/ec2-user/rusto/rusto.log" \
              "StandardError=append:/home/ec2-user/rusto/rusto.error.log" \
              "" \
              "[Install]" \
              "WantedBy=multi-user.target" \
              | sudo tee /etc/systemd/system/rusto.service > /dev/null

            sudo systemctl daemon-reload

            # Restart service
            echo "Restarting rusto service..."
            sudo systemctl stop rusto || true
            sleep 2
            sudo systemctl start rusto

            # Check status
            sleep 3
            sudo systemctl status rusto --no-pager

            echo "=== Deployment completed successfully ==="
          ENDSSH

      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            # Wait for service to be fully started
            sleep 5

            # Check if service is running
            if sudo systemctl is-active --quiet rusto; then
              echo "✓ Service is running"

              # Show recent logs
              echo ""
              echo "Recent logs:"
              sudo journalctl -u rusto -n 20 --no-pager

              exit 0
            else
              echo "✗ Service failed to start"
              echo ""
              echo "Error logs:"
              sudo journalctl -u rusto -n 50 --no-pager

              exit 1
            fi
          ENDSSH

      - name: Send deployment notification
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            COLOR=3066993
            TITLE="✅ Deployment Successful"
            DESCRIPTION="Rusto bot has been deployed to Tokyo EC2"
          else
            COLOR=15158332
            TITLE="❌ Deployment Failed"
            DESCRIPTION="Rusto bot deployment failed. Check logs."
          fi

          curl -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"$TITLE\", \"description\": \"$DESCRIPTION\", \"color\": $COLOR, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            "$DISCORD_WEBHOOK_URL" || true
